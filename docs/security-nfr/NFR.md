# Security & Non-Functional Requirements — Workouts Tracking API
| ID        | Название                                        | Описание (почему нужно)                                       | Метрика/Порог                                                                                | Проверка (чем/где)                                 | Компонент     | Приоритет |
|-----------| ----------------------------------------------- | ------------------------------------------------------------- | -------------------------------------------------------------------------------------------- | -------------------------------------------------- | ------------- | --------- |
| WF-NFR-01 | Единый конверт ошибок (problem+json)            | Предсказуемые ответы и удобная отладка фильтров/валидаторов   | 100% ошибок отдаются как `application/problem+json`, в теле есть `trace_id`/`correlation_id` | Контракт-тесты API, unit тесты middleware          | API           | High      |
| WF-NFR-02 | Ограничение выборок и пагинация                 | Защита БД и честные лимиты для списков тренировок             | `limit`: default 25, max 150; превышение → 400 (problem+json)                                | Тесты граничных значений, e2e на `/workouts`       | API           | High      |
| WF-NFR-03 | Производительность чтения с фильтрами           | Быстрый список тренировок по дате/упражнению/статусу          | p95 ≤ 180 ms при 40 RPS (stage) для `GET /workouts?…`                                        | k6/locust профиль чтения, Prometheus гистограммы   | Workouts Read | High      |
| WF-NFR-04 | Индексы под основные фильтры                    | Чтобы запросы не деградировали при росте данных               | Используются индексы `(user_id, performed_at DESC)` и `(user_id, exercise_id)`               | `EXPLAIN` план в интеграционных тестах             | DB            | Medium    |
| WF-NFR-05 | Целостность Workout↔Set↔Exercise                | Отсутствие «висячих» связей и частичных записей               | 0 нарушений FK/UNIQUE в property/fuzz-тесте на 10k операций                                  | Констрейнты БД + property-тесты                    | Data Layer    | High      |
| WF-NFR-06 | Идемпотентные записи тренировок                 | Повторы запросов не создают дубликаты                         | `POST /workouts` с одинаковым `Idempotency-Key` в 24ч → 1 запись                             | Интеграционные тесты ретраев                       | API           | Medium    |
| WF-NFR-07 | Структурные логи без чувствительных полей       | Диагностика без утечек содержимого тренировок                 | 0 вхождений полей `notes/body/tokens` в логах; каждый лог содержит `request_id`              | Линтер логов в CI + выборочная проверка            | Logging       | High      |
| WF-NFR-07 | Наблюдаемость: метрики и трассировка            | Видимость задержек и бизнес-показателей                       | `/metrics` отдаёт счётчики и гистограммы HTTP; есть `workouts_count`; трассы с `trace_id`    | Scrape Prometheus, проверка OTel экспортера        | Observability | Medium    |
| WF-NFR-09 | Доступность чтения                              | Список тренировок почти всегда доступен                       | 99.5% monthly availability для `GET /workouts`                                               | Аптайм-мониторинг + SLI по 5xx/таймаутам           | API Read      | Medium    |
| WF-NFR-10 | Аудит зависимостей (SCA)                        | Исключить известные уязвимости                                | CI падает при High/Critical; отчёт на каждый push/PR                                         | `pip-audit`/`safety` job в CI                      | Build/CI      | High      |
| WF-NFR-11 | Миграции с dry-run                              | Безопасные изменения схемы                                    | 100% схемных изменений через Alembic; `alembic upgrade --sql` успешно в CI                   | Отдельный job в CI, публикация артефакта SQL-плана | CI/DB         | Medium    |
| WF-NFR-12 | Стабильная сортировка и консистентная пагинация | Без дубликатов/пропусков при листании страниц                 | Сортировка `-performed_at, id`; инвариант: item не повторяется между страницами              | Контракт-тесты пагинации (пересечение страниц = ∅) | API           | Low       |
| WF-NFR-13 | Изоляция данных пользователя                    | Пользователь видит только свои тренировки                     | 0 кейсов доступа к чужим данным в e2e                                                        | E2E на попытки чтения/записи чужих ресурсов        | AuthZ/API     | High      |
